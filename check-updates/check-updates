#!/bin/bash

# Usage:
# check-updates <mailto-user>

MAILTO=$USER
if [[ $# -ge 1 ]]; then
    MAILTO=$1
fi

# will work only when called by root
apt-get update > /dev/null 2>&1

LIST=$(apt-get --just-print upgrade 2>&1 | sort | perl -ne 'if (/Inst\s([\w,\-,\d,\.,~,:,\+]+)\s\[([\w,\-,\d,\.,~,:,\+]+)\]\s\(([\w,\-,\d,\.,~,:,\+]+)\)? /i) {print "$1 from: $2 to: $3\n"}' | column -s " " -t)
HOLD=$(apt-mark showhold)

if [[ -z "$LIST" ]]; then
    exit 0
fi

mail -s "Pending system update(s)" $MAILTO < <(
echo -ne "Hello, $MAILTO!\nThere are some pending system updates that you might be interested in.\n\n"

if [[ -n "$HOLD" ]]; then
    echo -ne "** Packages being on hold (apt-mark unhold <package> to unhold):\n$(apt-mark showhold)\n\n"
fi

if [[ -n "$LIST" ]]; then
    echo -ne "** Packages ready for upgrade:\n$LIST\n\n"
fi

echo -ne "Remember to check apt-listbugs output after agreeing for update. Use 'apt-mark hold' for unwanted (buggy) packages.\n\n"
echo -ne "(Report generated by check-updates script)\n"
)
